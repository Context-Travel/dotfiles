#!/bin/sh

set -x

ROOT="$HOME/api"

tmate start-server

cd $ROOT

tmate new-session -d -s api -n vim vim

TMATE_DIR="/tmp/tmate-`id -u`"
TMATE_SESSION="$TMATE_DIR/`ls -t $TMATE_DIR | head -1`"

# Create other windows.
tmate -S $TMATE_SESSION new-window -c $ROOT -n gitsh
tmate -S $TMATE_SESSION new-window -c $ROOT -n sh
tmate -S $TMATE_SESSION new-window -c $ROOT -n server
tmate -S $TMATE_SESSION new-window -c $ROOT -n console
tmate -S $TMATE_SESSION new-window -c $ROOT -n db
tmate -S $TMATE_SESSION new-window -c $ROOT -n sidekiq

# Window "gitsh"
tmate -S $TMATE_SESSION send-keys -t api:2 gitsh C-m

# Window "server"
tmate -S $TMATE_SESSION send-keys -t api:4 'rails server' C-m

# Window "console"
tmate -S $TMATE_SESSION send-keys -t api:5 'rails console' C-m

# Window "db"
tmate -S $TMATE_SESSION send-keys -t api:6 'rails dbconsole' C-m

# Window "sidekiq"
tmate -S $TMATE_SESSION send-keys -t api:7 'bundle exec sidekiq' C-m

tmate -S $TMATE_SESSION select-window -t api:2

tmate -S $TMATE_SESSION attach-session -t api

# Show ssh
# Check ride of annoying text you have to quit on startup
# attach to already running session if running
# Add legacy admin as additional windows with special key bindings
# Start elasticsearch before starting server
# If server cannot start because of port kill whatever is running on 3000 first
